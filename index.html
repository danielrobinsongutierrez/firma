<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Firmas de Correo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .signature-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #333;
            line-height: 1.4;
            border-top: 2px solid #e5e7eb;
            padding-top: 15px;
            margin-top: 20px;
        }
        
        .signature-preview .logo {
            max-height: 45px; /* Reducido para Outlook */
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .signature-preview .name {
            font-size: 16px; /* Reducido para Outlook */
            font-weight: bold;
            color: #1f2937;
        }
        
        .signature-preview .position {
            color: #6b7280;
            font-style: italic;
            font-size: 13px; /* Reducido para Outlook */
        }
        
        .signature-preview .company {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            font-size: 12px; /* Reducido para Outlook */
        }
        
        .signature-preview .contact {
            color: #4b5563;
            font-size: 11px; /* Reducido para Outlook */
        }
        
        .signature-preview .contact a {
            color: #3b82f6;
            text-decoration: none;
        }
        
        .signature-preview .contact a:hover {
            text-decoration: underline;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .required-field::after {
            content: " *";
            color: #ef4444;
        }

        .invalid-field {
            border-color: #ef4444 !important;
        }
        
        .logo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logo-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f9fafb;
        }
        
        .logo-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px auto;
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-4">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800 mb-2">
                Generador de Firmas de Correo Interno de la Cooperativa
            </h1>
            <p class="text-slate-600">
                Creá firmas para tu correo electrónico completando el siguiente formulario
            </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Formulario -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="border-b">
                        <nav class="flex -mb-px" role="tablist">
                            <button class="tab-button py-4 px-6 border-b-2 border-blue-500 text-blue-600 font-medium" 
                                    data-tab="personal" 
                                    role="tab" 
                                    aria-selected="true" 
                                    aria-controls="personal-tab">
                                Datos Personales
                            </button>
                            <button class="tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" 
                                    data-tab="template" 
                                    role="tab" 
                                    aria-selected="false" 
                                    aria-controls="template-tab">
                                Configuración Plantilla
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Datos Personales -->
                    <div id="personal-tab" class="tab-content p-6 space-y-4" role="tabpanel" aria-labelledby="personal-tab">
                        <div>
                            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                Información Personal
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Ingresa tus datos personales para la firma
                            </p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1 required-field">
                                        Nombre Completo
                                    </label>
                                    <input
                                        type="text"
                                        id="fullName"
                                        placeholder="Juan Pérez García"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required
                                    >
                                    <span class="text-xs text-red-500 hidden" id="fullNameError">Este campo es obligatorio</span>
                                </div>
                                
                                <div>
                                    <label for="position" class="block text-sm font-medium text-gray-700 mb-1 required-field">
                                        Cargo / Puesto
                                    </label>
                                    <input
                                        type="text"
                                        id="position"
                                        placeholder="Gerente de Ventas"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required
                                    >
                                    <span class="text-xs text-red-500 hidden" id="positionError">Este campo es obligatorio</span>
                                </div>
                                
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                                        Teléfono
                                    </label>
                                    <input
                                        type="text"
                                        id="phone"
                                        placeholder="+54 0299 155 123 456"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                                
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                                        Correo Electrónico
                                    </label>
                                    <input
                                        type="email"
                                        id="email"
                                        placeholder="juan.perez"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p class="text-xs text-gray-500 mt-1">Se añadirá @copelco.coop automáticamente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuración Plantilla -->
                    <div id="template-tab" class="tab-content p-6 space-y-4 hidden" role="tabpanel" aria-labelledby="template-tab">
                        <div>
                            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                Configuración de la Plantilla
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Configura los datos de tu empresa (se guardará en el navegador para futuros usos)
                            </p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                                        Nombre de la Empresa
                                    </label>
                                    <input
                                        type="text"
                                        id="companyName"
                                        placeholder="Coop. Copelco ltda"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                                
                                <div>
                                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">
                                        Sitio Web
                                    </label>
                                    <input
                                        type="text"
                                        id="website"
                                        placeholder="www.copelco.coop"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Logo de la Empresa
                                    </label>
                                    
                                    <!-- Opción 1: Subir archivo -->
                                    <div class="mb-4">
                                        <div id="logoUploadArea" class="logo-upload-area">
                                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                            <p class="text-sm text-gray-600">Arrastra una imagen aquí o haz clic para seleccionar</p>
                                            <p class="text-xs text-gray-500 mt-1">PNG, JPG o SVG (máx. 2MB)</p>
                                            <input type="file" id="logoFile" accept="image/*" class="hidden">
                                        </div>
                                        <img id="logoPreview" class="logo-preview hidden" alt="Vista previa del logo">
                                    </div>
                                    
                                    <!-- Opción 2: URL externa -->
                                    <div>
                                        <label for="logo" class="block text-sm font-medium text-gray-700 mb-1">
                                            O ingresa la URL del logo
                                        </label>
                                        <input
                                            type="text"
                                            id="logo"
                                            placeholder="https://ejemplo.com/logo.png"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                        <p class="text-xs text-gray-500 mt-1">Para imágenes de dominios externos, asegúrate de que permitan CORS</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">
                                        Dirección
                                    </label>
                                    <textarea
                                        id="address"
                                        placeholder="Av. J. A. Roca 758"
                                        rows="2"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    ></textarea>
                                </div>
                                
                                <button id="saveTemplate" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                    <i class="fas fa-save mr-2"></i>
                                    Guardar Configuración
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Previa -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                        <i class="fas fa-eye"></i>
                        Vista Previa
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Así se verá tu firma en el correo electrónico
                    </p>
                    
                    <div class="bg-white border rounded-lg p-6 min-h-[200px]">
                        <div id="signaturePreview">
                            <div class="text-center text-gray-400 py-8">
                                <p>Completa los datos para ver la vista previa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Acciones</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Descarga la imagen de tu firma optimizada para Outlook
                    </p>
                    
                    <div class="space-y-4">
                        <button id="downloadImage" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors border-2 border-green-700">
                            <i class="fas fa-download mr-2"></i>
                            Descargar Imagen para Outlook
                        </button>
                        
                        <hr class="my-4">
                        
                        <div class="text-sm text-gray-600">
                            <p class="font-medium mb-2">Instrucciones:</p>
                            <ul class="space-y-1 text-xs">
                                <li>• Completa tus datos personales (obligatorios)</li>
                                <li>• Configura la plantilla de tu empresa</li>
                                <li>• Sube tu logo o ingresa la URL</li>
                                <li>• Descarga la imagen optimizada para Outlook</li>
                                <li>• Usa la firma en tu cliente de correo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="assertive">
        <div class="flex items-center">
            <div id="toastIcon" class="mr-3"></div>
            <div>
                <div id="toastTitle" class="font-medium"></div>
                <div id="toastMessage" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const personalTab = document.getElementById('personal-tab');
        const templateTab = document.getElementById('template-tab');
        const downloadButton = document.getElementById('downloadImage');
        const saveButton = document.getElementById('saveTemplate');
        const signaturePreview = document.getElementById('signaturePreview');
        const toast = document.getElementById('toast');
        
        // Campos del formulario
        const fullNameInput = document.getElementById('fullName');
        const positionInput = document.getElementById('position');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const companyNameInput = document.getElementById('companyName');
        const websiteInput = document.getElementById('website');
        const logoInput = document.getElementById('logo');
        const addressInput = document.getElementById('address');
        
        // Elementos para subir logo
        const logoUploadArea = document.getElementById('logoUploadArea');
        const logoFileInput = document.getElementById('logoFile');
        const logoPreview = document.getElementById('logoPreview');
        
        // Mensajes de error
        const fullNameError = document.getElementById('fullNameError');
        const positionError = document.getElementById('positionError');

        // Logo en base64 (fallback)
        const defaultLogoBase64 = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgNjAiPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iNjAiIGZpbGw9IiNmZmYiLz48dGV4dCB4PSIxMDAiIHk9IjM1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMzMzMiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNvcGVsY288L3RleHQ+PC9zdmc+';

        // Variable para almacenar el logo como base64
        let logoBase64 = null;

        // Establecer valores por defecto al cargar la página
        function setDefaultValues() {
            companyNameInput.value = 'Coop. Copelco ltda';
            websiteInput.value = 'www.copelco.coop'; // MODIFICADO: Agregado valor por defecto para sitio web
            logoInput.value = 'https://raw.githubusercontent.com/danielrobinsongutierrez/firma/707ef9244182e80b842e143de3a59b36a90395cd/logo-copelco.svg';
            addressInput.value = 'Av. J. A. Roca 758';
        }

        // Cargar plantilla guardada
        function loadTemplate() {
            const savedTemplate = localStorage.getItem('emailSignatureTemplate');
            if (savedTemplate) {
                const template = JSON.parse(savedTemplate);
                companyNameInput.value = template.companyName || 'Coop. Copelco ltda';
                websiteInput.value = template.website || 'www.copelco.coop'; // MODIFICADO: Agregado valor por defecto
                logoInput.value = template.logo || 'https://raw.githubusercontent.com/danielrobinsongutierrez/firma/707ef9244182e80b842e143de3a59b36a90395cd/logo-copelco.svg';
                addressInput.value = template.address || 'Av. J. A. Roca 758';
                
                // Cargar logo base64 si existe
                if (template.logoBase64) {
                    logoBase64 = template.logoBase64;
                    logoPreview.src = logoBase64;
                    logoPreview.classList.remove('hidden');
                }
            } else {
                // Valores por defecto si no hay plantilla guardada
                setDefaultValues();
            }
            updatePreview();
        }

        // Guardar plantilla
        function saveTemplate() {
            const template = {
                companyName: companyNameInput.value,
                website: websiteInput.value,
                logo: logoInput.value,
                address: addressInput.value,
                logoBase64: logoBase64
            };
            
            localStorage.setItem('emailSignatureTemplate', JSON.stringify(template));
            showToast('¡Guardado!', 'La configuración de la plantilla ha sido guardada.', 'success');
        }

        // Validar formulario
        function validateForm() {
            let isValid = true;
            
            // Validar nombre completo
            if (!fullNameInput.value.trim()) {
                fullNameInput.classList.add('invalid-field');
                fullNameError.classList.remove('hidden');
                isValid = false;
            } else {
                fullNameInput.classList.remove('invalid-field');
                fullNameError.classList.add('hidden');
            }
            
            // Validar posición
            if (!positionInput.value.trim()) {
                positionInput.classList.add('invalid-field');
                positionError.classList.remove('hidden');
                isValid = false;
            } else {
                positionInput.classList.remove('invalid-field');
                positionError.classList.add('hidden');
            }
            
            return isValid;
        }

        // Cambiar entre pestañas
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');
                
                // Actualizar botones
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                    btn.setAttribute('aria-selected', 'false');
                });
                button.classList.remove('border-transparent', 'text-gray-500');
                button.classList.add('border-blue-500', 'text-blue-600');
                button.setAttribute('aria-selected', 'true');
                
                // Actualizar contenido
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                if (targetTab === 'personal') {
                    personalTab.classList.remove('hidden');
                } else {
                    templateTab.classList.remove('hidden');
                }
            });
        });

        // Generar HTML de la firma
        function generateSignatureHTML() {
            const fullName = fullNameInput.value;
            const position = positionInput.value;
            const phone = phoneInput.value;
            const email = emailInput.value;
            const companyName = companyNameInput.value;
            const website = websiteInput.value;
            const logo = logoInput.value;
            const address = addressInput.value;
            
            // Usar logo base64 si está disponible, si no usar la URL
            const logoSrc = logoBase64 || logo;
            const logoHTML = logoSrc 
                ? `<img src="${logoSrc}" alt="${companyName}" class="logo" crossorigin="anonymous">`
                : "";

            // MODIFICADO: Asegurar que el sitio web tenga protocolo para el enlace
            let websiteUrl = website;
            if (websiteUrl && !websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                websiteUrl = 'https://' + websiteUrl;
            }

            return `
                <div class="signature-preview">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        ${logoHTML}
                        <div>
                            <div class="name">${fullName}</div>
                            <div class="position">${position}</div>
                        </div>
                    </div>
                    ${companyName ? `<div class="company">${companyName}</div>` : ""}
                    <div class="contact">
                        ${phone ? `<div><i class="fas fa-phone"></i> ${phone}</div>` : ""}
                        ${email ? `<div><i class="fas fa-envelope"></i> ${email}</div>` : ""}
                        ${website ? `<div><i class="fas fa-globe"></i> <a href="${websiteUrl}" target="_blank">${website}</a></div>` : ""}
                        ${address ? `<div><i class="fas fa-map-marker-alt"></i> ${address}</div>` : ""}
                    </div>
                </div>
            `;
        }

        // Actualizar vista previa con debounce
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function updatePreview() {
            const fullName = fullNameInput.value;
            const position = positionInput.value;
            
            if (fullName || position) {
                signaturePreview.innerHTML = generateSignatureHTML();
            } else {
                signaturePreview.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>Completa los datos para ver la vista previa</p>
                    </div>
                `;
            }
        }

        const debouncedUpdatePreview = debounce(updatePreview, 300);

        // Forzar actualización inicial para mostrar los valores por defecto
        function forceInitialUpdate() {
            // Mostrar vista previa con datos de la empresa aunque no haya datos personales
            const hasCompanyData = companyNameInput.value || logoInput.value || addressInput.value || logoBase64;
            
            if (hasCompanyData) {
                signaturePreview.innerHTML = generateSignatureHTML();
            }
        }

        // Calcular altura dinámica del canvas (optimizado para Outlook)
        function calculateCanvasHeight() {
            let height = 90; // Altura base reducida para Outlook
            
            if (companyNameInput.value) height += 20; // Empresa
            if (phoneInput.value) height += 15;       // Teléfono
            if (emailInput.value) height += 15;       // Email
            if (websiteInput.value) height += 15;     // Sitio web
            if (addressInput.value) height += 15;     // Dirección
            
            return height + 25; // Margen inferior reducido
        }

        // Función para cargar imagen con manejo de CORS mejorado
        function loadImageWithCORS(url) {
            return new Promise((resolve, reject) => {
                // Si es una imagen base64, cargar directamente
                if (url.startsWith('data:image')) {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error('No se pudo cargar la imagen base64'));
                    img.src = url;
                    return;
                }
                
                // Si es una URL externa, intentar con CORS
                const img = new Image();
                img.crossOrigin = 'Anonymous'; // Importante para CORS
                img.onload = () => resolve(img);
                img.onerror = () => {
                    // Si falla CORS, intentar sin crossOrigin
                    const img2 = new Image();
                    img2.onload = () => resolve(img2);
                    img2.onerror = () => reject(new Error('No se pudo cargar la imagen'));
                    img2.src = url;
                };
                img.src = url;
            });
        }

        // Función para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Manejar la subida de logo
        logoUploadArea.addEventListener('click', () => {
            logoFileInput.click();
        });

        logoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            logoUploadArea.classList.add('dragover');
        });

        logoUploadArea.addEventListener('dragleave', () => {
            logoUploadArea.classList.remove('dragover');
        });

        logoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            logoUploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                handleLogoFile(e.dataTransfer.files[0]);
            }
        });

        logoFileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleLogoFile(e.target.files[0]);
            }
        });

        async function handleLogoFile(file) {
            // Validar tipo de archivo
            if (!file.type.match('image.*')) {
                showToast('Error', 'Por favor selecciona un archivo de imagen válido.', 'error');
                return;
            }
            
            // Validar tamaño (máx. 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Error', 'El archivo es demasiado grande. El tamaño máximo es 2MB.', 'error');
                return;
            }
            
            try {
                // Convertir a base64
                logoBase64 = await fileToBase64(file);
                
                // Mostrar vista previa
                logoPreview.src = logoBase64;
                logoPreview.classList.remove('hidden');
                
                // Limpiar campo de URL
                logoInput.value = '';
                
                // Actualizar vista previa
                updatePreview();
                
                showToast('¡Logo cargado!', 'El logo se ha cargado correctamente.', 'success');
            } catch (error) {
                console.error('Error al procesar el logo:', error);
                showToast('Error', 'No se pudo procesar el archivo de imagen.', 'error');
            }
        }

        // Descargar imagen de la firma (optimizado para Outlook)
        async function downloadSignatureImage() {
            if (!validateForm()) {
                return;
            }
            
            const fullName = fullNameInput.value || 'Tu Nombre';
            const position = positionInput.value || 'Tu Cargo';
            const phone = phoneInput.value;
            const email = emailInput.value;
            const companyName = companyNameInput.value;
            const website = websiteInput.value;
            const logo = logoInput.value;
            const address = addressInput.value;

            // Crear un canvas para generar la imagen
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar dimensiones del canvas optimizadas para Outlook
            canvas.width = 500;  // Ancho reducido para Outlook
            canvas.height = calculateCanvasHeight(); // Altura optimizada
            
            // Fondo blanco
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            let yOffset = 25;  // Margen superior reducido
            
            // Función para dibujar el resto de la firma
            function drawRestOfSignature() {
                // Dibujar línea separadora más delgada
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(20, yOffset);
                ctx.lineTo(canvas.width - 20, yOffset);
                ctx.stroke();
                
                yOffset += 15;  // Espacio compacto
                
                // Dibujar nombre de la empresa
                if (companyName) {
                    ctx.fillStyle = '#374151';
                    ctx.font = 'bold 12px Arial'; // Fuente reducida
                    ctx.fillText(companyName, 20, yOffset);
                    yOffset += 18;
                }
                
                // Dibujar información de contacto
                ctx.fillStyle = '#4b5563';
                ctx.font = '11px Arial'; // Fuente reducida
                
                if (phone) {
                    ctx.fillText('📞 ' + phone, 20, yOffset);
                    yOffset += 12;
                }
                
                if (email) {
                    ctx.fillText('✉️ ' + email, 20, yOffset);
                    yOffset += 12;
                }
                
                if (website) {
                    // MODIFICADO: Asegurar que el sitio web se muestre correctamente en la imagen
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText('🌐 ' + website, 20, yOffset);
                    yOffset += 12;
                    ctx.fillStyle = '#4b5563';
                }
                
                if (address) {
                    ctx.fillText('📍 ' + address, 20, yOffset);
                }
                
                // Descargar la imagen
                downloadCanvas();
            }
            
            // Determinar la fuente del logo (base64 o URL)
            const logoSrc = logoBase64 || logo;
            
            // Cargar y dibujar logo si existe
            if (logoSrc) {
                try {
                    const img = await loadImageWithCORS(logoSrc);
                    
                    // Dibujar logo con tamaño optimizado para Outlook
                    const logoHeight = 45; // Reducido para Outlook
                    const logoWidth = (img.width * logoHeight) / img.height;
                    
                    // Verificar que la imagen se haya cargado correctamente
                    if (img.width > 0 && img.height > 0) {
                        ctx.drawImage(img, 20, yOffset - 5, logoWidth, logoHeight);
                        
                        // Dibujar nombre y posición al lado del logo
                        ctx.fillStyle = '#1f2937';
                        ctx.font = 'bold 16px Arial'; // Fuente reducida
                        ctx.fillText(fullName, logoWidth + 40, yOffset + 12);
                        
                        ctx.fillStyle = '#6b7280';
                        ctx.font = 'italic 13px Arial'; // Fuente reducida
                        ctx.fillText(position, logoWidth + 40, yOffset + 30);
                        
                        yOffset += 45; // Espacio compacto
                    } else {
                        throw new Error('La imagen no se cargó correctamente');
                    }
                    
                    // Continuar con el resto de la información
                    drawRestOfSignature();
                } catch (error) {
                    console.error('Error al cargar el logo:', error);
                    showToast('Error', 'No se pudo cargar el logo. La firma se generará sin logo.', 'error');
                    drawSignatureWithoutLogo();
                }
            } else {
                drawSignatureWithoutLogo();
            }
            
            function drawSignatureWithoutLogo() {
                // Dibujar nombre y posición
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 16px Arial'; // Fuente reducida
                ctx.fillText(fullName, 20, yOffset + 12);
                
                ctx.fillStyle = '#6b7280';
                ctx.font = 'italic 13px Arial'; // Fuente reducida
                ctx.fillText(position, 20, yOffset + 30);
                
                yOffset += 45; // Espacio compacto
                drawRestOfSignature();
            }
            
            function downloadCanvas() {
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'firma-outlook.png'; // Nombre de archivo específico
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('¡Descargado!', 'Firma optimizada para Outlook', 'success');
                }, 'image/png');
            }
        }

        // Mostrar notificación
        function showToast(title, message, type = 'success') {
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Configurar icono
            if (type === 'success') {
                toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                toast.className = 'toast success show';
            } else {
                toastIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
                toast.className = 'toast error show';
            }
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Event listeners con debounce
        fullNameInput.addEventListener('input', debouncedUpdatePreview);
        positionInput.addEventListener('input', debouncedUpdatePreview);
        phoneInput.addEventListener('input', debouncedUpdatePreview);
        emailInput.addEventListener('input', debouncedUpdatePreview);
        companyNameInput.addEventListener('input', debouncedUpdatePreview);
        websiteInput.addEventListener('input', debouncedUpdatePreview);
        logoInput.addEventListener('input', debouncedUpdatePreview);
        addressInput.addEventListener('input', debouncedUpdatePreview);
        
        // Precargar dominio del correo
        emailInput.addEventListener('blur', function() {
            if (this.value && !this.value.includes('@')) {
                this.value = this.value + '@copelco.coop';
                debouncedUpdatePreview();
            }
        });
        
        downloadButton.addEventListener('click', downloadSignatureImage);
        saveButton.addEventListener('click', saveTemplate);

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultValues();
            loadTemplate();
            // Forzar actualización inicial para mostrar vista previa con datos por defecto
            setTimeout(forceInitialUpdate, 100);
        });
    </script>
</body>
</html>
